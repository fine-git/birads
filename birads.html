<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>BIRADS Tab</title>
<style>
body { font-family: "メイリオ", sans-serif; padding: 20px; }
fieldset { margin-bottom: 15px; }
legend { font-weight: bold; }
label { margin-right: 10px; }
input[type="text"] { width: 60px; text-align: right; }
#total { margin-top: 10px; font-weight: bold; white-space: pre-wrap; }
button { margin-right: 5px; }
</style>
</head>
<body>

<div id="biradsTab"></div>
<div>
    <button id="copyBtn">diagnosis</button>
</div>
<div id="total"></div>

<script>
const wordList = {
    shape: { title: "Shape", type: "checkbox", items: ['円形','卵形','分葉状','不整形','造影されるT2WI高信号結節'], joinMethod: "、" },
    margin: { title: "Margin", type: "checkbox", items: ['辺縁平滑','辺縁不整','spiculaあり','周囲浮腫あり','嚢胞内結節'], joinMethod: "、" },
    distribution: { title: "Distribution", type: "checkbox", items: ['diffuse','multiple','focal','regional','linear','segmental','+ nodule'], joinMethod: "／" },
    enhancement: { title: "Enhancement", type: "checkbox", items: ['homogenous','heterogeneous','rim','dark septations','clumped','cluster ring'], joinMethod: "／" },
    kinetici: { title: "Kinetic curve initial", type: "radio", items: ['fast','medium','slow'], joinMethod: "／" },
    kineticd: { title: "Kinetic curve delayed", type: "radio", items: ['persistent','plateau','washout'], joinMethod: "／" },
    add_finding: { title: "Additional findings", type: "checkbox", items: ['微小石灰化','構築の乱れ','high ADC','low ADC','MIP feeder','乳管内進展','乳頭浸潤','胸壁浸潤','皮膚浸潤','リンパ節転移','触知可能','一連の病変','小さすぎて質的診断困難'], joinMethod: "、" }
};

const vars = {};
const container = document.getElementById('biradsTab');

function createCheckboxes() {
    for (const key in wordList) {
        const group = wordList[key];
        const fieldset = document.createElement('fieldset');
        const legend = document.createElement('legend');
        legend.textContent = group.title;
        fieldset.appendChild(legend);

        if(group.type === "checkbox") vars[key] = [];
        
        group.items.forEach((item, i) => {
            const label = document.createElement('label');
            const input = document.createElement('input');
            input.type = group.type;
            input.name = key + (group.type === "radio" ? '' : i);
            input.value = String(i); // インデックスを文字列として保存
            input.addEventListener('change', () => {
                if (group.type === "radio") vars[key] = input.value; // 選択時に vars に格納
                collectData();
            });
            label.appendChild(input);
            label.appendChild(document.createTextNode(item));
            fieldset.appendChild(label);

            if(group.type === "checkbox") vars[key].push(input);
        });

        container.appendChild(fieldset);
    }

    // Massサイズ入力
    const sizeFieldset = document.createElement('fieldset');
    const sizeLegend = document.createElement('legend');
    sizeLegend.textContent = 'Mass Size (mm)';
    sizeFieldset.appendChild(sizeLegend);
    const sizeInput = document.createElement('input');
    sizeInput.type = 'number';
    sizeInput.id = 'massSize';
    sizeInput.addEventListener('input', updateTotal);
    sizeFieldset.appendChild(sizeInput);
    container.appendChild(sizeFieldset);
}


async function collectData() {
    const data = {};
    for (const key in wordList) {
        const group = wordList[key];
        if (group.type === "checkbox") {
            data[key] = vars[key]
                .map((input, i) => input.checked ? String(i) : null)
                .filter(v => v !== null);
        } else if (group.type === "radio") {
            data[key] = vars[key] || "";
        }
    }

    const massSizeInput = document.getElementById('massSize');
    data['massSize'] = massSizeInput ? massSizeInput.value : "";

    const hasKinetic = data.kineticd && data.kinetici;
    const hasMorphology = ((data.shape && data.shape.length > 0) && (data.margin && data.margin.length > 0)) || 
                          (data.distribution && data.distribution.length > 0);

    let diagnosis = "";
    if (hasKinetic && hasMorphology) {
        try {
            // Cloudflare Worker API に POST
            const response = await fetch("https://birads.hny.workers.dev", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            const json = await response.json();
            diagnosis = json.result;
        } catch (err) {
            diagnosis = "API エラー: " + err.message;
        }
    } else {
        diagnosis = "必要な項目が未選択です";
    }

    document.getElementById('total').textContent = diagnosis;
}

function updateTotal(data) {
    let categoryStr = "";
    let bi_score = 0;
    let nme_score = 0;

    const mass_size = data.massSize ? parseInt(data.massSize) : 0;

    // --- NME側 ---
    if (data.distribution.length > 0) {
        // segmental/linear
        if (data.distribution.includes("5") || data.distribution.includes("4")) nme_score += 1000;
        else if (data.distribution.includes("2") || data.distribution.includes("3")) nme_score += 10;

        // kinetic
        if (data.kinetici == "0" && data.kineticd == "1") nme_score += 50;

        // enhancement
        if (data.enhancement.includes("5")) nme_score += 1000;
        else if (data.enhancement.includes("4")) nme_score += 100;

        // NME category判定
        let nme_category = 0;
        if (nme_score === 0) {
            categoryStr = "BPEの範疇と考えます。";
            nme_category = 20;
        } else if (nme_score >= 1 && nme_score <= 10) {
            categoryStr = "BPEや乳腺症を考えますが、focalな所見なので、フォローが望ましいです。";
            nme_category = 39;
        } else if (nme_score >= 11 && nme_score <= 60) {
            categoryStr = "r/o DCISです。";
            nme_category = 41;
        } else if (nme_score >= 61 && nme_score <= 1009) {
            categoryStr = "まずはDCISを疑います。";
            nme_category = 44;
        } else if (nme_score >= 1010 && nme_score <= 1999) {
            categoryStr = "DCISを考えます。";
            nme_category = 47;
        } else {
            categoryStr = "c/w DCISです。";
            nme_category = 50;
        }

        // 追加所見による修正
        if (data.add_finding.includes("3")) { // low ADC +浸潤癌
            if (nme_category > 20) categoryStr = "まずはDCIS（＋浸潤癌の可能性）を疑います。";
            else if (nme_category == 20) categoryStr = "背景のBPEに加え、focalにADC低下が見られ、この部分はr/o DCIS～浸潤癌です。";
            nme_category = nme_category > 20 ? nme_category + 3 : 40;
        } else if (data.kineticd == "2") { // washout +浸潤癌
            if (nme_category > 20) categoryStr = "まずはDCIS（＋浸潤癌の可能性）を疑います。";
            else if (nme_category == 20) categoryStr = "背景のBPEに加え、focalにwashoutが見られ、この部分はr/o DCIS～浸潤癌です。";
            nme_category = nme_category > 20 ? nme_category + 3 : 40;
        } else if (data.distribution.includes("6")) { // 結節 +浸潤癌
            if (nme_category > 20) categoryStr = "まずはDCIS（＋浸潤癌の可能性）を疑います。";
            nme_category += nme_category > 20 ? 3 : 0;
        }

        // さらに追加所見
        if (data.add_finding.includes("9")) { // リンパ節転移
            if (nme_category < 50) {
                categoryStr = "DCIS～浸潤癌を疑います。";
                nme_category = 50;
            }
        } else if (["6","7","8"].some(i => data.add_finding.includes(i))) { // 浸潤進展
            if (nme_category > 20) {
                categoryStr = "DCIS～浸潤癌を疑います。";
                nme_category = Math.min(nme_category + 5, 49);
            } else if (nme_category == 20) {
                categoryStr = "背景のBPEに混在しているものと思いますが、局所的な浸潤傾向からr/o DCISです。";
                nme_category = 42;
            }
        } else if (data.add_finding.includes("10")) { // Palpable
            if (nme_category > 20) categoryStr = "触知可能な病変のようなので、生検が望ましいです。";
            else if (nme_category == 20) {
                categoryStr = "背景のBPEに混在しているものと思いますが、触知可能な病変はr/o DCISです。";
                nme_category = 40;
            }
        }

        // diffuse BPE feeder
        if (data.add_finding.includes("4")) {
            if (nme_category > 20) categoryStr = "病変との関連が疑われる血管拡張／血流増加あり。DCISの可能性があります。";
            else if (nme_category == 20) categoryStr = "分布はBPE様ですが、病変との関連が疑われる血管拡張／血流増加あり、r/o DCIS～浸潤癌です。";
            nme_category = nme_category > 20 ? nme_category + 3 : 40;
        }

        // 微小石灰化 / 構築の乱れ
        if (data.add_finding.includes("0")) { // 微小石灰化
            if (nme_category >= 30 && nme_category <= 39) categoryStr = "MRI所見はBPEや乳腺症でも良いと思いますが、ご指摘の微小石灰化部位に一致するのであればr/o DCISです。";
            else if (nme_category == 20) categoryStr = "MRI所見はBPEの範疇と考えますが、focalな微小石灰化が見られているようなので、フォローが望ましいです。";
        } else if (data.add_finding.includes("1")) { // 構築の乱れ
            if (nme_category >= 30 && nme_category <= 39) categoryStr = "MRI所見はBPEや乳腺症でも良いと思いますが、ご指摘の構築の乱れの部位に一致するのであればr/o DCISです。";
            else if (nme_category == 20) categoryStr = "MRI所見はBPEの範疇と考えますが、構築の乱れが見られているようなので、フォローが望ましいです。";
        }

        // 最終カテゴリ
        let final_category = "";
        if (nme_category == 20) final_category = "1";
        else if (nme_category >= 21 && nme_category <= 39) final_category = "3";
        else if (nme_category >= 40 && nme_category <= 41) final_category = "4a";
        else if (nme_category >= 42 && nme_category <= 45) final_category = "4b";
        else if (nme_category >= 46 && nme_category <= 49) final_category = "4c";
        else final_category = "5";

        categoryStr += "\n→category " + final_category;

    } else {
        if (data.margin.includes("2")) { // spicula
            if (data.kineticd == "0") bi_score = 6; // persistent
            else if (data.kineticd == "1") { // plateau
                bi_score = data.margin.includes("3") ? 9 : 7;
            } else if (data.kineticd == "2") { // washout
                bi_score = data.margin.includes("3") ? 11 : 10;
            }
        } else if (data.margin.includes("4")) { // 嚢胞内病変
            if (![0,1,2].some(i => data.margin.includes(i.toString()))) return "error: marginを選択";
            if (data.enhancement.includes("2")) {
                categoryStr = "complicated cystから考えますが、年齢が高くr/o DCIS（嚢胞性乳癌）です。";
                bi_score = 6;
            } else {
                categoryStr = "嚢胞内乳頭腫から考えたいですが、MRI上は広基性に見え、r/o 悪性です。";
                bi_score = 6;
            }
        } else if (data.shape.includes("4")) { // T2high
            if (![0,1,2,3].some(i => data.shape.includes(i.toString()))) return "error: shapeを選択";

            if (data.kineticd == "0" && (data.enhancement.includes("0") || data.enhancement.includes("3")) && (data.shape.includes("0") || data.shape.includes("1")) && data.margin.includes("0")) {
                categoryStr = "線維腺腫から考えます。";
                bi_score = 4;
            } else if (data.kineticd == "2") { // washout
                if (data.enhancement.includes("0") || data.enhancement.includes("3")) {
                    categoryStr = "線維腺腫から考えますが、washoutありr/o 悪性です。";
                    bi_score = 5;
                } else {
                    if (data.margin.includes("0") && data.enhancement.includes("2")) {
                        categoryStr = "complicated cystから考えますが、年齢が高くr/o DCIS（嚢胞性乳癌）です。";
                        bi_score = 6;
                    } else {
                        categoryStr = "線維腺腫から考えますが、粘液癌は鑑別です。";
                        bi_score = 5;
                    }
                }
            } else if (data.kineticd == "0" && data.kinetici == "2") { // slow-persistent
                categoryStr = "T2WI高信号で、造影パターンからは粘液癌＞線維腺腫の疑いです。";
                bi_score = 6;
            } else if (data.kinetici == "0") {
                if (data.add_finding.includes("3")) { // low ADC
                    categoryStr = "乳癌や乳管内乳頭腫が鑑別です。";
                    bi_score = 6;
                } else {
                    categoryStr = "線維腺腫から考えますが、粘液癌は鑑別です。";
                    bi_score = 5;
                }
            } else {
                categoryStr = "線維腺腫から考えますが、粘液癌は鑑別です。";
                bi_score = 5;
            }

            if (mass_size > 49) {
                categoryStr = "葉状腫瘍を疑います。嚢胞変性を伴っています。悪性を疑うようなADC低下や出血壊死を疑うT1WI高信号は指摘できません。";
                bi_score = 6;
            } else if (mass_size > 29) {
                categoryStr += "サイズから葉状腫瘍は鑑別です。嚢胞変性も伴っています。悪性を疑うようなADC低下や出血壊死を疑うT1WI高信号は指摘できません。";
            }
        } else if (data.margin.includes("0") || data.margin.includes("1")) { // spiculaなし
            if (data.kineticd == "0") { // persistent
                if (data.margin.includes("1")) { // 不整
                    if (data.kinetici == "0") { // fast
                        if (data.add_finding.includes("3")) {
                            categoryStr = "ADC低下あり、乳癌を疑います。";
                            bi_score = 7;
                        } else {
                            categoryStr = "";
                            bi_score = 4;
                        }
                    } else {
                        if (data.add_finding.includes("3")) {
                            categoryStr = "ADC低下あり、乳癌を疑います。";
                            bi_score = 6;
                        } else {
                            categoryStr = "非特異的です。";
                            bi_score = 3;
                        }
                    }
                } else if (data.margin.includes("0")) { // 平滑
                    if (data.kinetici == "0") {
                        categoryStr = "線維腺腫や拡張した血管が鑑別です。";
                        bi_score = 5;
                    } else {
                        categoryStr = "悪性を示唆する所見に乏しいです。";
                        bi_score = 1;
                    }
                }
            } else if (data.kineticd == "1") { // plateau
                if (data.margin.includes("1")) {
                    if (data.kinetici == "0") {
                        if (data.add_finding.includes("3")) {
                            categoryStr = "ADC低下あり、乳癌を疑います。";
                            bi_score = 7;
                        } else if (data.add_finding.includes("2")) {
                            categoryStr = "ADCがかなり高く、線維腺腫＞乳癌を考えます。";
                            bi_score = 5;
                        } else {
                            categoryStr = "乳癌を疑います。";
                            bi_score = 6;
                        }
                    } else {
                        categoryStr = "陳旧性の線維腺腫が鑑別です。";
                        bi_score = 4;
                    }
                } else if (data.margin.includes("0")) {
                    if (data.kinetici == "0") {
                        if (data.add_finding.includes("3")) {
                            categoryStr = "ADC低下あり、乳癌を疑います。";
                            bi_score = 6;
                        } else if (data.add_finding.includes("2")) {
                            categoryStr = "ADCがかなり高く、線維腺腫から考えます。";
                            bi_score = 4;
                        } else {
                            categoryStr = "線維腺腫やリンパ節が鑑別です。";
                            bi_score = 5;
                        }
                    } else {
                        categoryStr = "悪性を示唆する所見に乏しいです。";
                        bi_score = 2;
                    }
                }
            } else if (data.kineticd == "2") { // washout
                if (data.enhancement.includes("0") || data.enhancement.includes("3")) {
                    categoryStr = "線維腺腫から考えます。";
                    bi_score = 5;
                } else {
                    if (data.margin.includes("0")) {
                        categoryStr = "乳管内乳頭腫とDCISが鑑別です。";
                        bi_score = 6;
                    } else {
                        bi_score = 8;
                    }
                }
            }
        }

        // 微小石灰化による修正
        if (bi_score < 4 && data.add_finding.includes("0")) {
            if (bi_score <= 2) {
                categoryStr = "悪性を示唆する所見に乏しいものの、ご指摘の微小石灰化部位に一致するのであれば、フォローが望ましいです。";
                bi_score = 4;
            } else if (bi_score == 3) {
                categoryStr = "非特異的ですが、ご指摘の微小石灰化部位に一致すればr/o DCISです。";
                bi_score = 5;
            }
        }

        // 血管拡張
        if (data.add_finding.includes("4")) {
            bi_score += 1;
            categoryStr = "病変との関連が疑われる血管拡張／血流増加あり。" + categoryStr;
        }

        // リンパ節転移、浸潤進展、触知可能
        if (data.add_finding.includes("9")) {
            bi_score = 10;
            categoryStr = "";
        } else if ([5,6,7,8].some(i => data.add_finding.includes(i.toString()))) {
            bi_score = Math.max(5, bi_score + 1);
            categoryStr = "";
        } else if (data.add_finding.includes("10")) {
            bi_score = Math.max(5, bi_score + 1);
            categoryStr = "触知可能な病変のようなので、生検が望ましいです。";
        }

        // old focus
        if (data.add_finding.includes("12")) {
            if (data.shape.includes("4")) {
                bi_score = 2;
                categoryStr = "T2WI高信号で、良性を考えます。";
            } else {
                bi_score = data.kineticd == "2" ? 5 : 4;
            }
        }

        // Kaiser Score category
        let ks_category = "";
        if (bi_score <= 2) ks_category = "2";
        else if (bi_score == 3) ks_category = "2/3";
        else if (bi_score == 4) ks_category = "3";
        else if (bi_score == 5) ks_category = "4a";
        else if (bi_score == 6) ks_category = "4b";
        else if (bi_score == 7) ks_category = "4c";
        else ks_category = "5";

        categoryStr += "\n→category " + ks_category;
    }

    return categoryStr;
}

// ボタンイベント
document.getElementById('copyBtn').addEventListener('click', ()=>{
    collectData();
});

createCheckboxes(); // これだけでOK
collectData();

</script>
</body>
</html>
